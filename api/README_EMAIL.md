# שליחת מייל (Resend) – משתני סביבה

כדי ששליחת מייל תעבוד (טופס צור קשר **ו** שליחת הטבות למייל), צריך להגדיר ב-**Vercel** (או בסביבה שבה רצים ה-API) את המשתנים הבאים.

## משתנים נדרשים

| משתנה | תיאור |
|--------|--------|
| `RESEND_API_KEY` | מפתח API מ-Resend (Dashboard → API Keys). |
| `CONTACT_FROM_EMAIL` או `FROM_EMAIL` | כתובת המייל **ממנה** נשלחים המיילים (חייבת להיות דומיין מאומת ב-Resend). |

## איפה להגדיר

1. **Vercel:**  
   Project → **Settings** → **Environment Variables**  
   להוסיף `RESEND_API_KEY` ו־`CONTACT_FROM_EMAIL` (או `FROM_EMAIL`) עם הערכים המתאימים.

2. **פיתוח מקומי:**  
   בקובץ `.env.local` (או `.env`) ברמת הפרויקט:
   ```
   RESEND_API_KEY=re_xxxxx
   CONTACT_FROM_EMAIL=onboarding@resend.dev
   ```
   (להחליף בכתובת מהדומיין שלך ב-Resend.)

## שימוש

- **טופס צור קשר** (`/api/contact`) – משתמש ב־`RESEND_API_KEY` ו־`CONTACT_FROM_EMAIL`.
- **שליחת הטבה למייל** (`/api/send-benefit-email`) – משתמש באותם משתנים; אם חסר אחד מהם, השליחה דולגת (לא נשלח מייל) בלי להפיל את האפליקציה.

אם כבר הגדרת Resend לטופס צור קשר – **אין צורך בהגדרה נוספת**; שליחת ההטבות למייל תשתמש באותם משתנים.

---

## מייל אימות בהרשמה – מקור יחיד, מייל אחד

**כלל: בעת רישום לאפליקציה מתקבל מייל אימות אחד למייל (1 לחשבון).**  
מקור המייל היחיד הוא **האפליקציה** דרך `api/send-confirmation-email` (Resend), בעיצוב Viraly: רקע כהה, כפתור צהוב "כניסה לחשבון". אין לשלוח מייל אימות ממקור אחר (Supabase כבוי דרך Auth Hook).

### למניעת מיילים כפולים (רק מייל אחד – העיצוב הממורכז)

מייל האימות **הנכון** הוא זה עם **מלל ממורכז**, כפתור צהוב "כניסה לחשבון", רקע כהה – נשלח רק מ־API זה. כל מייל אחר (למשל מלל מוצמד לימין) נשלח מ-Supabase.

- **מצד האפליקציה:** נשלח **רק מייל אחד** (מניעת כפילות בלקוח + idempotency ב-API).
- **כדי שלא יגיעו מיילים מ-Supabase** – להפעיל Auth Hook "Send Email" שמחזיר 200 בלי לשלוח:
  1. לפרוס את הפונקציה: מתוך שורש הפרויקט להריץ:
     ```bash
     supabase functions deploy auth-send-email --no-verify-jwt
     ```
  2. ב-**Supabase Dashboard** → **Authentication** → **Auth Hooks** → **Send Email Hook**:
     - להפעיל את ה-Hook.
     - **Hook URL:** `https://<project-ref>.supabase.co/functions/v1/auth-send-email` (להחליף `<project-ref>` ב־Project ID מהדשבורד).
  3. אחרי ההפעלה, Supabase לא ישלח מייל אימות והמשתמש יקבל **רק** את המייל מהאפליקציה.
  4. **Idempotency:** הרצת מיגרציה `20260208140000_confirmation_email_idempotency.sql` (טבלה + פונקציית RPC) מבטיחה שכל עוד כמה קריאות ל-API – רק אחת תשלח מייל (חלון 2 דקות לאימייל).

### משתני סביבה למייל אימות

אותם משתנים כמו בשאר המיילים: `RESEND_API_KEY`, `CONTACT_FROM_EMAIL` (או `FROM_EMAIL`). אם הם מוגדרים ב־Vercel – מייל האימות יעבוד.

---

## מחיקת משתמשים (פאנל ניהול)

- **מחיקה רגילה:** בלשונית "משתמשים" – כפתור "מחק" ליד המשתמש. מוחק את כל הנתונים (פרופיל, ניתוחים, מנויים וכו') **וגם** מ-Supabase Auth. זו הדרך המומלצת.
- **משתמשים בלי פרופיל:** משתמש שנרשם ב-Auth אבל אין לו שורה ב-`profiles` לא יופיע ברשימה. למחוק אותו: באותה לשונית יש "מחק משתמש לפי אימייל" – להזין אימייל ולחץ "מחק לפי אימייל". הפעולה מוחקת גם מ-Auth.

# שליחת מייל (Resend) – משתני סביבה

כדי ששליחת מייל תעבוד (טופס צור קשר **ו** שליחת הטבות למייל), צריך להגדיר ב-**Vercel** (או בסביבה שבה רצים ה-API) את המשתנים הבאים.

## משתנים נדרשים

| משתנה | תיאור |
|--------|--------|
| `RESEND_API_KEY` | מפתח API מ-Resend (Dashboard → API Keys). |
| `CONTACT_FROM_EMAIL` או `FROM_EMAIL` | כתובת המייל **ממנה** נשלחים המיילים (חייבת להיות דומיין מאומת ב-Resend). |

## איפה להגדיר

1. **Vercel:**  
   Project → **Settings** → **Environment Variables**  
   להוסיף `RESEND_API_KEY` ו־`CONTACT_FROM_EMAIL` (או `FROM_EMAIL`) עם הערכים המתאימים.

2. **פיתוח מקומי:**  
   בקובץ `.env.local` (או `.env`) ברמת הפרויקט:
   ```
   RESEND_API_KEY=re_xxxxx
   CONTACT_FROM_EMAIL=onboarding@resend.dev
   ```
   (להחליף בכתובת מהדומיין שלך ב-Resend.)

## שימוש

- **טופס צור קשר** (`/api/contact`) – משתמש ב־`RESEND_API_KEY` ו־`CONTACT_FROM_EMAIL`.
- **שליחת הטבה למייל** (`/api/send-benefit-email`) – משתמש באותם משתנים; אם חסר אחד מהם, השליחה דולגת (לא נשלח מייל) בלי להפיל את האפליקציה.

אם כבר הגדרת Resend לטופס צור קשר – **אין צורך בהגדרה נוספת**; שליחת ההטבות למייל תשתמש באותם משתנים.

---

## מייל אימות בהרשמה – מקור יחיד: Supabase

**מייל אימות נשלח רק מ-Supabase.** האפליקציה אינה שולחת מייל אימות.

- הפעלה/כיבוי אימות מייל: **Supabase Dashboard** → **Authentication** → **Providers** → **Email** → **Confirm email**.
- אם מוגדר Auth Hook "Send Email" שמחזיר 200 בלי לשלוח – כבה או הסר אותו כדי ש-Supabase ישלח.

### משתני סביבה למייל אימות

אותם משתנים כמו בשאר המיילים: `RESEND_API_KEY`, `CONTACT_FROM_EMAIL` (או `FROM_EMAIL`). אם הם מוגדרים ב־Vercel – מייל האימות יעבוד.

---

## מחיקת משתמשים (פאנל ניהול)

- **מחיקה רגילה:** בלשונית "משתמשים" – כפתור "מחק" ליד המשתמש. מוחק את כל הנתונים (פרופיל, ניתוחים, מנויים וכו') **וגם** מ-Supabase Auth. זו הדרך המומלצת.
- **משתמש שמופיע ב-Supabase אבל לא באדמין:** רשימת המשתמשים באדמין נבנית מטבלת `profiles`. אם למשתמש אין שורה ב-`profiles` (למשל נרשם אבל לא השלים אימות, או שהטריגר ליצירת פרופיל לא רץ) – הוא יופיע רק ב-Supabase Authentication ולא ברשימת האדמין. למחוק אותו: באותה לשונית "משתמשים" → "מחק משתמש לפי אימייל" → להזין אימייל ולחץ "מחק לפי אימייל".
- **"Database error deleting user" במחיקה מ-Supabase Dashboard:** המחיקה בדשבורד של Supabase מוחקת רק מ-Auth. אם יש טבלאות ב-public שמפנות ל-`auth.users` (מנויים, הזמנות, אירועי מנוי וכו') – המחיקה תיכשל. לכן יש **למחוק תמיד מהפאנל ניהול** (או "מחק לפי אימייל"): שם קודם נמחקות כל השורות הרלוונטיות ואז המשתמש מ-Auth.
